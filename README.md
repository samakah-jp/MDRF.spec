## Markdown Diff Review Format (MDRF) v3.0 仕様書

### バージョン

3.0

### 1. 目的

Markdown Diff Review Format (MDRF) は、コードの変更差分（diff）、関連するメタデータ（コミット情報、ファイルパス、ファイル固有情報など）、および特定のコード箇所に関する議論（コメントスレッド）とそのメタデータ（ステータス、種類、コンテキストスニペットなど）、さらにコメント間の返信関係を明確に、人間が読みやすく、かつツールでの処理も可能な形で単一のMarkdownファイルに記録・共有するためのフォーマットです。

このフォーマットは**Markdownのサブセット**として定義されており、特定の構造とルールに従う必要があります。コードレビューのプロセスや結果を文書化する際に利用することを想定しています。

### 2. 主な特徴

* **柔軟なグルーピング:** H2レベルでコミット以外の単位（機能、フォルダなど）でのグルーピングが可能。標準種別として `Version`, `Path` を定義。
* **JSON Schemaによる厳密なメタデータ定義:** メタデータの構造が明確。
* **Markdownサブセットとしての制約強化:** フォーマットの曖昧さを排除。
* **標準化されたタイムスタンプ:** ISO 8601形式に統一。
* **明確でパースしやすい返信指定:** `:reply_to[ID]` 記法をヘッダー直後の独立行に限定。
* **コメントIDの推奨命名規則:** `<スレッド番号>.<コメント番号>` 形式を推奨。
* **コンテキストスニペットによる補強 (推奨):** コード変更に対するコメント箇所の特定を補助。複数行スニペットの推奨形式を提示。
* **コメントスレッド:** 議論の流れを追跡可能。スレッド番号はファイル単位で連番。
* **スレッド単位のメタデータ:** 全体の複雑性を低減。
* **明確なバージョン管理:** `mdrf_version` でバージョンを明示。
* **柔軟なコメントメタデータ:** `status`, `type` に推奨値を設定しつつ、任意の文字列も許容（警告推奨）。
* **キーワードの非感受性:** ヘッダー内のキーワード（`Commit`, `Thread`, `Renamed` など）は**大文字/小文字を区別しません**。
* **明確な空白ルール:** ヘッダー内のキーワードと識別子の間の空白は、**1つ以上必須**です。
* **空コメントの禁止:** 各コメントには本文が必要です。
* **コメント本文中のHTML見出し (非推奨):** Markdown見出しは禁止ですが、`<h1>`-`<h5>` タグの使用は許容されます（非推奨）。
* **推奨エンコーディングと改行:** UTF-8 (BOM無し) と LF (`\n`) を推奨し、互換性を高めます。
* **可読性:** 標準的なMarkdownとYAMLで読み書きが容易。
* **ツール親和性:** 構造化されており、ツールによる処理が比較的容易。

### 3. 基本構造

ファイル全体は特定の構造を持つMarkdownドキュメントとして構成されます。主要な情報は以下の階層構造で整理されます。

#### 3.1. ファイル全体 (H1レベル)

* ファイルは必ずH1見出しから始まり、その形式は `# <レビュータイトル>` でなければなりません。タイトル以外のテキストや他のレベルの見出しがこれより前にあってはいけません。
* **YAML Front Matter:** H1見出しの直後に、`---` で囲まれたYAMLブロックを**必ず**配置します。
    * `mdrf_version` (必須): 値は `3.0` である必要があります。
    * タイムスタンプ形式: このファイル内で使用される全てのタイムスタンプは **ISO 8601形式** (例: `2025-05-01T20:15:30+09:00` または `2025-05-01T11:15:30Z`) に準拠する必要があります。
    * その他のキー（`project`, `review_date`, `participants` など）は任意ですが、その構造はJSON Schema (`FrontMatter`) に従います。

#### 3.2. グルーピング単位 (H2レベル)

* 各レビュー対象のまとまり（グループ）をH2見出しで区切ります。形式は `## <グループ種別>:<グループ名/ID>` でなければなりません。
    * `<グループ種別>` はファイル作成者が定義する任意の文字列です。**キーワードの大文字/小文字は区別しません**。
        * **標準グループ種別 (推奨):** `Version`, `Path` の使用を推奨します。
        * 上記以外のカスタム種別も使用可能です。
    * `<グループ名/ID>` はそのグループを識別する空でない文字列です。
    * `<グループ種別>` と `:` の間、および `:` と `<グループ名/ID>` の間には、**必ず1つ以上の空白文字（スペース、タブなど。改行を除く）** が必要です。
* **グループメタデータ (任意):** H2見出しの直後に、任意で `group_metadata` キーを持つYAMLブロック (```yaml ... ```) を配置できます。
    * このYAMLブロックの内容は、JSON Schema (`GroupMetadata`) に従います。
    * `group_type` (推奨): H2見出しで使われた `<グループ種別>` を小文字で記述することを推奨します。

#### 3.3. ファイル単位 / Diff (H3レベル)

* 各ファイルセクションは必ずH3見出しから始まり、その形式は以下のいずれかでなければなりません。
    * 変更/追加: `### <変更後のファイルパス>`
    * リネーム: `### <変更後のファイルパス> (Renamed)`
    * 移動: `### <変更後のファイルパス> (Moved)`
    * リネームかつ移動: `### <変更後のファイルパス> (Moved)`
    * 削除: `### <変更前のファイルパス> (Removed)`
    * **注意:** `(Renamed)`, `(Moved)`, `(Removed)` のキーワードの大文字/小文字は区別しません。ファイルパスとこれらのキーワードの間には**必ず1つ以上の空白文字**が必要です。
* **ファイルメタデータ (任意):** H3見出しの直後に、任意で `metadata` キーを持つYAMLブロック (```yaml ... ```) を配置できます。
    * このYAMLブロックの内容は、JSON Schema (`FileMetadata`) に従います。`file_path` は必須で、H3ヘッダーのパスと一致する必要があります。
* `**Diff:**` ラベルと `diff` コードブロックは必須です。**キーワード `Diff` の大文字/小文字は区別しません**。`**` と `Diff` の間、`Diff` と `:` の間に空白があってはいけません。

#### 3.4. コメントスレッド (H4レベル)

* 各コメントスレッドは必ずH4見出しから始まり、その形式は `#### Thread <スレッド番号> [on Line <行番号>]` でなければなりません。
    * キーワード `Thread` の**大文字/小文字は区別しません**。
    * `Thread` と `<スレッド番号>` の間には**必ず1つ以上の空白文字**が必要です。
    * `on Line` 部分は任意です。存在する場合、キーワード `on` および `Line` の**大文字/小文字は区別しません**。`on` と `Line` の間、`Line` と `<行番号>` の間には**必ず1つ以上の空白文字**が必要です。
    * `<スレッド番号>` は、**そのH3レベル（ファイル単位 / Diffセクション）内で1から始まる連番の整数**です。
    * `<行番号>` は1以上の整数です。
* **スレッドメタデータ (任意):** H4見出しの直後に、任意で `thread_meta` キーを持つYAMLブロック (```yaml ... ```) を配置できます。
    * このYAMLブロックの内容は、JSON Schema (`ThreadMetadata`) に従います。
    * `status`, `type` の推奨値、`context_snippet` の推奨事項は以下の通りです。
        * `status`: スレッド全体の状態 (`open`, `addressed`, `resolved`, `wontfix` を推奨)。
        * `type`: スレッドの主題 (`issue`, `suggestion`, `question`, `nitpick` を推奨)。
        * `context_snippet` (推奨): 議論対象のコードブロック（`on Line` で指定された行を開始点または代表点とする複数行）を文字列として含めることを推奨。**複数行の場合はYAMLのリテラルブロックスタイル (`|`) を使用することを推奨します。**
    * 推奨値以外の `status`, `type` が使用された場合、ツールは警告(Warning)を出すことが推奨されます。

#### 3.5. 個別コメント (H5レベル)

* 各個別コメントは必ずH5見出しから始まり、その形式は `##### [<コメントID>] <ユーザー名> (<タイムスタンプ>)` でなければなりません。
    * コメントID `[<コメントID>]` は任意です。指定する場合、`<スレッド番号>.<コメント番号>` 形式を推奨します。**ここでの `<コメント番号>` は、そのコメントスレッド内で1から始まる連番です。**
    * タイムスタンプ `(<タイムスタンプ>)` は必須で、ISO 8601形式である必要があります。
* **返信指定子:** `:reply_to[<対象コメントID>]` は任意です。
    * 指定する場合、**H5ヘッダーの次の非空行**に、この指定子**のみ**を記述する必要があります。
* **コメント本文:** 返信指定行の後（または返信指定がない場合はH5ヘッダーの次の行）から標準的なMarkdownで記述します。**コメント本文は空であってはいけません。** 何らかの内容を含む必要があります。
    * **本文中の見出し:**
        * コメント本文中でMarkdownの見出し (`#`, `##` など) を使用することは、MDRFの構造と衝突するため**許可されません**。
        * 本文内で見出しのような表現を使いたい場合は、**HTMLの `<h1>`〜`<h5>` タグを使用することが許容されますが、推奨はされません**。可読性やツール互換性の観点から、Markdownの太字 (`**`) や水平線 (`---`) などで代用することを検討してください。
        * **注意:** `<h1>`〜`<h5>` 以外のHTMLタグの解釈や表示は、使用するビューアーやレンダリングツールに依存し、MDRF仕様では定義しません。セキュリティ上の理由から、ツールはHTMLタグをサニタイズ（無害化）することが推奨されます。

#### 3.6. ファイル形式の詳細

* **文字エンコーディング:** ファイルは **UTF-8 (BOM無し)** でエンコードされていることを**強く推奨します**。
* **改行コード:** ファイル内の改行コードは **LF (`\n`)** を使用することを**強く推奨します**。

### 4. データ解釈を目的としたパーサー実装ガイドライン (Parser Implementation Guidelines for Data Interpretation)

このセクションは、MDRF v3.0ファイルを単に表示するだけでなく、内容を構造化データとして抽出し、分析、集計、検証などの処理を行うツール（パーサー、リンター、データ抽出器など）を実装する開発者向けのガイドラインです。これらのルールを厳密に適用することで、データの一貫性と信頼性を高めることができます。

**表示のみを目的とするツールは、これらの制約を緩和し、より寛容な（ベストエフォートな）解析を行っても構いません。**

#### 4.1. 構造と形式の厳密な検証

* **見出しレベルと順序:** パーサーは、H1, H2, H3, H4, H5 の階層構造と、仕様書に定められた順序を厳密に検証する必要があります。予期しない順序やレベルの見出しはエラーとして扱うべきです。
* **見出し形式:** 各レベルの見出しは、仕様書に記載された形式に**構造的に一致**する必要があります。
    * キーワード（`Commit`, `Thread`, `Renamed`, `Moved`, `Removed`, `on`, `Line`, `Diff`）の**大文字/小文字は区別せずに**マッチングする必要があります。
    * キーワードと識別子/番号/パスを区切る空白は、**必ず1つ以上の空白文字（スペース、タブなど。改行を除く）** が存在するか検証する必要があります。
    * 上記以外の形式の不一致はエラーとして扱うべきです。
* **必須要素:** 仕様書で「必須」とされている要素が存在しない場合はエラーとして扱うべきです。

#### 4.2. メタデータのJSON Schema検証

* 各YAMLメタデータブロック（Front Matter, `group_metadata`, `metadata`, `thread_meta`）の内容は、仕様書で定義された対応するJSON Schemaに対して厳密に検証されるべきです。
* スキーマ違反はエラーとして扱うべきです。
* `additionalProperties: true` が指定されているスキーマでは未知のキーは許容されますが、ツールによっては未知のキーに対して警告を出すことも検討できます。

#### 4.3. タイムスタンプ形式の検証

* ファイル内の全てのタイムスタンプは、ISO 8601形式に準拠しているか検証する必要があります。形式が不正な場合はエラーとして扱うべきです。

#### 4.4. IDと参照の検証

* **コメントIDのユニーク性:** H5見出しで `[<コメントID>]` が指定されている場合、そのIDが所属するコメントスレッド内でユニークであることを検証すべきです。重複が見つかった場合はエラーとして扱うべきです。
* **`:reply_to` の参照先検証:** `:reply_to[<対象コメントID>]` が指定されている場合、`<対象コメントID>` が同じコメントスレッド内に存在する有効なコメントIDであるか検証すべきです。存在しないIDを参照している場合はエラーとして扱うべきです。

#### 4.5. `:reply_to` の配置検証

* `:reply_to[<対象コメントID>]` は、H5ヘッダーの次の「非空行」に、それ「のみ」が記述されている必要があります。
* `:reply_to` が含まれる行に他のテキストが存在する場合や、コメント本文中に現れた場合はエラーとして扱うべきです。

#### 4.6. `status`/`type` の推奨値に関する扱い

* スレッドメタデータの `status` および `type` キーの値が、仕様書で定義された推奨値以外である場合、パーサーはエラーではなく**警告 (Warning)** を生成することが推奨されます。

#### 4.7. エラーハンドリングと報告

* 上記の検証でエラーが検出された場合、パーサーはどのファイルのどの部分（可能であれば行番号）で、どのルールに違反したかを具体的に示すエラーメッセージを生成すべきです。
* 複数のエラーが検出される可能性も考慮し、可能な限り多くの問題を報告することが望ましいです。
* エラー発生時に処理を完全に中断するか、エラーを記録しつつ解析を試みるかは、パーサーの設計方針によりますが、少なくともエラーが発生したことは明確にユーザーに伝える必要があります。

#### 4.8. 空のコメント本文の禁止

* パーサーは、H5見出し（および任意の `:reply_to` 行）の後に続くコメント本文が空でないことを検証すべきです。空の本文はエラーとして扱うべきです。

#### 4.9. コメント本文中の見出しの扱い

* パーサーは、H5コメント本文中に現れるMarkdownの見出し (`#`, `##` など) を、MDRFの構造を示す見出しとして**解釈してはいけません**。これらは単なるテキストとして扱うべきです（またはエラーとして報告することも可能です）。
* パーサーは、コメント本文中のHTML見出しタグ (`<h1>`〜`<h5>`) を**任意で解釈**し、構造化データや表示に反映させることができます。ただし、これは必須機能ではありません。
* パーサーは、コメント本文中の `<h1>`〜`<h5>` 以外のHTMLタグを解釈・検証する必要はありません。セキュリティのため、HTMLタグを無害化（サニタイズ）することが強く推奨されます。

### 5. ライセンス

この仕様書およびMDRFフォーマットは、**Unlicense** の下に提供されます。これは実質的にパブリックドメインに置かれることを意味し、誰でも自由に複製、配布、変更、利用（商用利用を含む）することができます。

```
This is free and unencumbered software released into the public domain.

Anyone is free to copy, modify, publish, use, compile, sell, or
distribute this software, either in source code form or as a compiled
binary, for any purpose, commercial or non-commercial, and by any
means.

In jurisdictions that recognize copyright laws, the author or authors
of this software dedicate any and all copyright interest in the
software to the public domain. We make this dedication for the benefit
of the public at large and to the detriment of our heirs and
successors. We intend this dedication to be an overt act of
relinquishment in perpetuity of all present and future rights to this
software under copyright law.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR
OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.

For more information, please refer to <https://unlicense.org/>
```

### 6. 謝辞

この仕様書は、Gemini 2.5 Pro との対話を通じて作成されました。
